{% extends "base.html" %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (BGE-M3){% endblock %}

{% block header_title %}üß† –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (BGE-M3){% endblock %}
{% block header_subtitle %}–°–æ–∑–¥–∞–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞{% endblock %}

{% block extra_styles %}
<style>
    .nav-pills .nav-link.active {
        background-color: #3498db;
        border-color: #3498db;
    }
    .embedding {
        background-color: #eaf7ea;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
    }
    .full-embedding {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    .file-info {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
</style>
{% endblock %}

{% block content %}
<div class="model-info">
    <strong>–ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å:</strong> BAAI/bge-m3<br>
    <strong>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</strong> –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 100+ —è–∑—ã–∫–æ–≤, —Ä–∞–±–æ—Ç–∞ —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –¥–æ 8192 —Ç–æ–∫–µ–Ω–æ–≤, —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤: 1024
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <ul class="nav nav-pills card-header-pills" id="modeTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#singleMode" type="button" role="tab" aria-controls="singleMode" aria-selected="true">üéØ –û–¥–∏–Ω–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cache-tab" data-bs-toggle="tab" data-bs-target="#cacheMode" type="button" role="tab" aria-controls="cacheMode" aria-selected="false">üìö –ò–∑ –∫—ç—à–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="modeTabsContent">
            <!-- –†–µ–∂–∏–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
            <div class="tab-pane fade show active" id="singleMode" role="tabpanel" aria-labelledby="single-tab">
                <div class="error" id="error-message" style="display:none;"></div>
                <div class="form-group mb-3">
                    <label for="file-upload" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: {{ supported_exts_single|join(', ') }})</label>
                    <input type="file" class="form-control" id="file-upload" name="files" multiple>
                    <div class="form-text">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 10 –ú–ë</div>
                </div>
                <button class="btn btn-primary btn-lg w-100 mb-4" onclick="processSingleFiles()">–°–æ–∑–¥–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏</button>
                <div class="result" id="single-result-container" style="display:none;">
                    <h3 class="mb-3">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h3>
                    <div id="single-results"></div>
                </div>
            </div>
            <!-- –†–µ–∂–∏–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫—ç—à–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div class="tab-pane fade" id="cacheMode" role="tabpanel" aria-labelledby="cache-tab">
                <div class="mb-4">
                    <p class="mb-3">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∫—ç—à–∞ <code>scan_cache.pkl</code>, —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.</p>
                    <div class="form-group mb-3">
                        <label for="cache-file" class="form-label">–§–∞–π–ª –∫—ç—à–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (.pkl)</label>
                        <input type="file" class="form-control" id="cache-file" accept=".pkl">
                    </div>
                    <button class="btn btn-success btn-lg w-100 mb-4" onclick="processCacheFile()">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫—ç—à</button>
                </div>
                <div class="card mt-4" id="cache-status-card" style="display:none;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üìä –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫—ç—à–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</span>
                                <span id="cache-status-badge" class="status-badge bg-secondary">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                            </div>
                        </div>
                        <div class="progress" style="display: none;" id="cache-progress-container">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" id="cache-progress-bar" style="width: 0%">0%</div>
                        </div>
                        <div class="mt-3" id="cache-current-file-container" style="display: none;">
                            <small>–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª:</small>
                            <p class="mb-0 text-truncate" id="cache-current-file" style="max-width: 100%;"></p>
                        </div>
                        <div class="mt-4" id="cache-stats-container" style="display: none;">
                            <div class="row text-center">
                                <div class="col-6">
                                    <h5 id="cache-processed-count">0</h5>
                                    <small class="text-muted">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</small>
                                </div>
                                <div class="col-6">
                                    <h5 id="cache-remaining-time">-</h5>
                                    <small class="text-muted">–û—Å—Ç–∞–ª–æ—Å—å</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4" id="cache-result-container" style="display: none;">
                            <div class="alert alert-success">
                                <h5 class="alert-heading">‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h5>
                                <p>–≠–º–±–µ–¥–¥–∏–Ω–≥–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: <strong id="cache-result-path"></strong></p>
                                <p>–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: <strong id="cache-total-processed">0</strong></p>
                                <p>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <strong id="cache-execution-time">0</strong> —Å–µ–∫—É–Ω–¥</p>
                                <button class="btn btn-primary mt-3" id="download-cache-result">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
                            </div>
                        </div>
                        <div class="mt-4" id="cache-error-container" style="display: none;">
                            <div class="alert alert-danger">
                                <h5 class="alert-heading">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ</h5>
                                <p id="cache-error-message"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let cacheInterval;
    let isProcessingCache = false;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    async function processSingleFiles() {
        const fileInput = document.getElementById('file-upload');
        const files = fileInput.files;
        const errorElement = document.getElementById('error-message');
        const resultContainer = document.getElementById('single-result-container');
        const resultsDiv = document.getElementById('single-results');
        
        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        errorElement.style.display = 'none';
        resultContainer.style.display = 'none';
        resultsDiv.innerHTML = '';
        
        if (files.length === 0) {
            showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª');
            return;
        }
        
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }
        
        try {
            const response = await fetch('/generate_embeddings', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                data.results.forEach(result => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'file-info';
                    
                    if (result.error) {
                        resultDiv.innerHTML = `<strong>${result.filename}</strong>: ${result.error}`;
                    } else {
                        const embeddingPreview = result.embedding.slice(0, 10).join(', ') + '...';
                        resultDiv.innerHTML = `
                            <strong>${result.filename}</strong> (${result.format.toUpperCase()}):
                            <div class="mt-2">
                                <span class="badge bg-info">–§–æ—Ä–º–∞—Ç: ${result.format.toUpperCase()}</span>
                                <span class="badge bg-secondary ms-2">–î–ª–∏–Ω–∞: ${result.text_length} —Å–∏–º–≤–æ–ª–æ–≤</span>
                            </div>
                            <div class="embedding mt-2">
                                <p class="mb-1"><strong>–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å:</strong> ${result.embedding.length}</p>
                                <p class="mb-1"><strong>–í–µ–∫—Ç–æ—Ä —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ (–ø–µ—Ä–≤—ã–µ 10 –∑–Ω–∞—á–µ–Ω–∏–π):</strong></p>
                                <pre class="mb-0">[${embeddingPreview}]</pre>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="showFullEmbedding(this)">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é</button>
                                <div class="full-embedding" style="display: none;">
                                    <pre>${JSON.stringify(result.embedding, null, 2)}</pre>
                                </div>
                            </div>
                        `;
                    }
                    
                    resultsDiv.appendChild(resultDiv);
                });
                
                resultContainer.style.display = 'block';
            } else {
                showError(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–æ–≤');
            }
        } catch (error) {
            showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + error.message);
        }
    }
    
    function showError(message) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        errorElement.scrollIntoView({behavior: 'smooth'});
    }
    
    function showFullEmbedding(button) {
        const fullEmbeddingDiv = button.nextElementSibling;
        if (fullEmbeddingDiv.style.display === 'none') {
            fullEmbeddingDiv.style.display = 'block';
            button.textContent = '–°–∫—Ä—ã—Ç—å';
        } else {
            fullEmbeddingDiv.style.display = 'none';
            button.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é';
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—ç—à–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    async function processCacheFile() {
        const fileInput = document.getElementById('cache-file');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∫—ç—à–∞');
            return;
        }
        
        if (file.name !== 'scan_cache.pkl' && !file.name.endsWith('.pkl')) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∫—ç—à–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ .pkl');
            return;
        }
        
        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        document.getElementById('cache-status-card').style.display = 'block';
        document.getElementById('cache-progress-container').style.display = 'none';
        document.getElementById('cache-current-file-container').style.display = 'none';
        document.getElementById('cache-stats-container').style.display = 'none';
        document.getElementById('cache-result-container').style.display = 'none';
        document.getElementById('cache-error-container').style.display = 'none';
        
        const formData = new FormData();
        formData.append('cache_file', file);
        
        try {
            const response = await fetch('/start_cache_processing', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                isProcessingCache = true;
                document.getElementById('cache-status-badge').className = 'status-badge bg-warning';
                document.getElementById('cache-status-badge').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞';
                document.getElementById('cache-progress-container').style.display = 'block';
                document.getElementById('cache-current-file-container').style.display = 'block';
                document.getElementById('cache-stats-container').style.display = 'block';
                
                // –ó–∞–ø—É—Å–∫ –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞
                clearInterval(cacheInterval);
                cacheInterval = setInterval(updateCacheStatus, 1000);
            } else {
                showCacheError(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫—ç—à–∞');
            }
        } catch (error) {
            showCacheError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + error.message);
        }
    }
    
    function updateCacheStatus() {
        if (!isProcessingCache) return;
        
        fetch('/cache_status')
            .then(response => response.json())
            .then(data => {
                if (!data) return;
                
                document.getElementById('cache-progress-bar').style.width = data.progress + '%';
                document.getElementById('cache-progress-bar').textContent = data.progress + '%';
                document.getElementById('cache-current-file').textContent = data.current_file || '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';
                document.getElementById('cache-processed-count').textContent = data.processed;
                
                if (data.status === 'completed') {
                    finishCacheProcessing(data);
                } else if (data.status === 'error') {
                    showCacheError(data.error_message);
                } else if (data.status === 'idle') {
                    clearInterval(cacheInterval);
                    isProcessingCache = false;
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            });
    }
    
    function finishCacheProcessing(data) {
        clearInterval(cacheInterval);
        isProcessingCache = false;
        
        document.getElementById('cache-status-badge').className = 'status-badge bg-success';
        document.getElementById('cache-status-badge').textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
        document.getElementById('cache-progress-bar').className = 'progress-bar bg-success';
        document.getElementById('cache-result-path').textContent = data.result_path;
        document.getElementById('cache-total-processed').textContent = data.processed;
        document.getElementById('cache-execution-time').textContent = (data.end_time - data.start_time).toFixed(1);
        document.getElementById('cache-result-container').style.display = 'block';
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        document.getElementById('download-cache-result').onclick = function() {
            window.location.href = '/download_embeddings_cache';
        };
    }
    
    function showCacheError(message) {
        clearInterval(cacheInterval);
        isProcessingCache = false;
        
        document.getElementById('cache-status-badge').className = 'status-badge bg-danger';
        document.getElementById('cache-status-badge').textContent = '–û—à–∏–±–∫–∞';
        document.getElementById('cache-error-message').textContent = message;
        document.getElementById('cache-error-container').style.display = 'block';
    }
</script>
{% endblock %}

{% block footer_text %}
–°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ ‚Ä¢ {{ current_year }} ‚Ä¢ –ü–æ—Ä—Ç: {{ port }}
{% endblock %}