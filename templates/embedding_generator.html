<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор эмбеддингов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Генератор эмбеддингов</a>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Загрузка кэша сканирования</h5>
            </div>
            <div class="card-body">
                <form id="processForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="cacheFile" class="form-label">Файл кэша сканирования</label>
                        <input class="form-control" type="file" id="cacheFile" name="cache_file" accept=".pkl">
                        <div class="form-text">
                            Загрузите файл кэша, созданный сканером документов (.pkl)
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="processBtn">Начать генерацию эмбеддингов</button>
                    <button type="button" class="btn btn-danger" id="stopBtn" disabled>Остановить</button>
                </form>
            </div>
        </div>
        
        <div class="card mt-4" id="progressCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">Прогресс генерации эмбеддингов</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>Текущая задача:</strong>
                        <span id="currentTask">-</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small id="progressText">0%</small>
                        <small id="timeEstimate">Оставшееся время: -</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>Обработано текстов:</strong>
                        <span id="processedCount">0</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>Затраченное время:</strong>
                        <span id="elapsedTime">0с</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>Скорость обработки:</strong>
                        <span id="processingSpeed">0 текстов/сек</span>
                    </div>
                </div>
                
                <div class="alert alert-info" id="statusMessage">Ожидание запуска...</div>
            </div>
        </div>
        
        <div class="card mt-4" id="timingHistoryCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">История производительности</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="timingTable">
                        <thead>
                            <tr>
                                <th>Задача</th>
                                <th>Время</th>
                                <th>Элементов</th>
                                <th>Скорость</th>
                                <th>Дата</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут добавлены через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Информация о системе</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <strong>Модель эмбеддингов:</strong> 
                                <span class="badge bg-secondary">{{ config.EMBEDDING_MODEL }}</span>
                            </li>
                            <li class="list-group-item">
                                <strong>Размер батча:</strong> 
                                <span class="badge bg-secondary">{{ config.BATCH_SIZE_EMBEDDING }}</span>
                            </li>
                            <li class="list-group-item">
                                <strong>Использование FP16:</strong> 
                                <span class="badge bg-{% if config.USE_FP16 %}success{% else %}secondary{% endif %}">
                                    {% if config.USE_FP16 %}Да{% else %}Нет{% endif %}
                                </span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <strong>Суточный лимит работы:</strong> 
                                <span class="badge bg-secondary">{{ config.MAX_DAILY_WORK_HOURS }} часов</span>
                            </li>
                            <li class="list-group-item">
                                <strong>Чекпоинтинг:</strong> 
                                <span class="badge bg-success">Каждые {{ config.CHECKPOINT_INTERVAL }} файлов</span>
                            </li>
                            <li class="list-group-item">
                                <strong>Память GPU:</strong>
                                <span id="gpuMemory" class="badge bg-info">Проверка...</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer mt-4 py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">Генератор эмбеддингов &copy; {{ now.year }}</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            const progressCard = $('#progressCard');
            const timingHistoryCard = $('#timingHistoryCard');
            let processInterval;
            let lastProcessedCount = 0;
            let lastUpdateTime = Date.now();
            
            $('#processForm').on('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                // Скрываем карту истории времени при новом запуске
                timingHistoryCard.hide();
                
                $.ajax({
                    url: '/process-cache',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'started') {
                            $('#processBtn').prop('disabled', true);
                            $('#stopBtn').prop('disabled', false);
                            progressCard.show();
                            $('#statusMessage').removeClass('alert-danger alert-warning').addClass('alert-info').text('Генерация эмбеддингов запущена...');
                            
                            // Запускаем опрос статуса
                            clearInterval(processInterval);
                            processInterval = setInterval(updateStatus, 1000);
                        } else if (response.error) {
                            alert('Ошибка: ' + response.error);
                        }
                    },
                    error: function(xhr) {
                        alert('Ошибка: ' + xhr.responseText);
                    }
                });
            });
            
            $('#stopBtn').on('click', function() {
                $.ajax({
                    url: '/stop-generation',
                    method: 'POST',
                    success: function(response) {
                        if (response.status === 'stopped') {
                            $('#statusMessage').removeClass('alert-info alert-warning').addClass('alert-warning').text('Генерация остановлена. Сохранение прогресса...');
                            // Продолжаем опрашивать статус для отображения сохранения чекпоинта
                        }
                    }
                });
            });
            
            function updateStatus() {
                $.get('/status', function(data) {
                    // Обновляем прогресс
                    $('#progressBar').css('width', data.progress + '%').text(data.progress + '%');
                    $('#progressText').text(data.progress + '%');
                    $('#currentTask').text(data.current_task || '-');
                    $('#processedCount').text(data.processed_items + ' из ' + data.total_items);
                    $('#elapsedTime').text(data.elapsed_time_formatted || '0с');
                    
                    // Рассчитываем скорость обработки
                    const currentTime = Date.now();
                    const timeDiff = (currentTime - lastUpdateTime) / 1000; // в секундах
                    const countDiff = data.processed_items - lastProcessedCount;
                    
                    if (timeDiff > 1 && countDiff > 0) {
                        const speed = countDiff / timeDiff;
                        $('#processingSpeed').text(speed.toFixed(1) + ' текстов/сек');
                        lastProcessedCount = data.processed_items;
                        lastUpdateTime = currentTime;
                    }
                    
                    // Обновляем оставшееся время
                    if (data.remaining_time > 0) {
                        $('#timeEstimate').text('Оставшееся время: ' + data.remaining_time_formatted);
                    }
                    
                    // Обновляем сообщение статуса
                    if (data.message) {
                        let alertClass = 'alert-info';
                        if (data.status === 'completed') alertClass = 'alert-success';
                        if (data.status === 'stopped' || data.status === 'error') alertClass = 'alert-warning';
                        
                        $('#statusMessage')
                            .removeClass('alert-info alert-success alert-warning alert-danger')
                            .addClass(alertClass)
                            .html(data.message.replace(/\n/g, '<br>'));
                    }
                    
                    // Проверяем статус для остановки опроса
                    if (data.status === 'completed' || data.status === 'error') {
                        clearInterval(processInterval);
                        $('#processBtn').prop('disabled', false);
                        $('#stopBtn').prop('disabled', true);
                        
                        // Загружаем историю производительности после завершения
                        setTimeout(loadTimingHistory, 1000);
                    }
                    
                    // Проверяем, нужно ли приостановить работу из-за лимита времени
                    if (data.should_pause && data.status === 'running') {
                        $('#statusMessage')
                            .removeClass('alert-info alert-success alert-warning alert-danger')
                            .addClass('alert-warning')
                            .html('Система автоматически приостановит работу через 30 секунд из-за достижения суточного лимита времени. Прогресс будет сохранен.');
                    }
                });
            }
            
            function loadTimingHistory() {
                $.get('/timing-history', function(data) {
                    if (data && data.length > 0) {
                        timingHistoryCard.show();
                        let tableBody = $('#timingTable tbody');
                        tableBody.empty();
                        
                        data.forEach(item => {
                            const date = new Date(item.timestamp);
                            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                            const speed = item.items_per_second ? item.items_per_second.toFixed(1) : '0.0';
                            
                            tableBody.append(`
                                <tr>
                                    <td>${item.task}</td>
                                    <td>${formatDuration(item.duration)}</td>
                                    <td>${item.items_processed}</td>
                                    <td>${speed} эл/сек</td>
                                    <td>${formattedDate}</td>
                                </tr>
                            `);
                        });
                    }
                });
            }
            
            function formatDuration(seconds) {
                if (seconds < 0) seconds = 0;
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                
                if (hours > 0) {
                    return `${hours}ч ${minutes}м ${secs}с`;
                } else if (minutes > 0) {
                    return `${minutes}м ${secs}с`;
                } else {
                    return `${secs}с`;
                }
            }
            
            function checkGpuMemory() {
                // Для демонстрации эмулируем проверку памяти GPU
                // В реальном приложении здесь был бы запрос к серверу для получения реальных данных
                const usedMemory = Math.floor(Math.random() * 6) + 2; // 2-7 ГБ
                const totalMemory = 8; // RTX 2070 имеет 8 ГБ
                const percentage = Math.round((usedMemory / totalMemory) * 100);
                
                let badgeClass = 'bg-info';
                if (percentage > 80) badgeClass = 'bg-danger';
                else if (percentage > 60) badgeClass = 'bg-warning';
                
                $('#gpuMemory').removeClass('bg-info bg-warning bg-danger').addClass(badgeClass)
                              .html(`${usedMemory} ГБ / ${totalMemory} ГБ (${percentage}%)`);
                
                // Повторяем проверку каждые 5 секунд
                setTimeout(checkGpuMemory, 5000);
            }
            
            // Запускаем проверку памяти GPU
            checkGpuMemory();
        });
    </script>
</body>
</html>