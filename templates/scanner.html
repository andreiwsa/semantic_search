<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сканер документов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Сканер документов</a>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Параметры сканирования</h5>
            </div>
            <div class="card-body">
                <form id="scanForm">
                    <div class="mb-3">
                        <label for="rootDir" class="form-label">Корневая директория</label>
                        <input type="text" class="form-control" id="rootDir" name="root_dir" value="{{ default_dir }}">
                        <div class="form-text">Директория для рекурсивного сканирования документов</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="minFileSize" class="form-label">Минимальный размер файла (байт)</label>
                            <input type="number" class="form-control" id="minFileSize" name="min_file_size" value="{{ min_file_size }}">
                        </div>
                        <div class="col-md-6">
                            <label for="maxTextLen" class="form-label">Максимальная длина текста (символы)</label>
                            <input type="number" class="form-control" id="maxTextLen" name="max_text_len" value="2000000">
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="useCache" name="use_cache" checked>
                        <label class="form-check-label" for="useCache">Использовать кэш для инкрементального обновления</label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="addTimestamp" name="add_timestamp" checked>
                        <label class="form-check-label" for="addTimestamp">Добавить временную метку к имени кэша</label>
                    </div>
                    
                    <div class="mb-3">
                        <p class="mb-1"><strong>Поддерживаемые форматы:</strong></p>
                        <div class="d-flex flex-wrap gap-2">
                            {% for ext in supported_exts %}
                                <span class="badge bg-secondary">{{ ext }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="startScanBtn">Начать сканирование</button>
                    <button type="button" class="btn btn-danger" id="stopScanBtn" disabled>Остановить</button>
                </form>
            </div>
        </div>
        
        <div class="card mt-4" id="progressCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">Прогресс сканирования</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>Текущая задача:</strong>
                        <span id="currentTask">-</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small id="progressText">0%</small>
                        <small id="timeEstimate">Оставшееся время: -</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>Обработано файлов:</strong>
                        <span id="processedCount">0</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>Затраченное время:</strong>
                        <span id="elapsedTime">0с</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>Скорость обработки:</strong>
                        <span id="processingSpeed">0 файлов/сек</span>
                    </div>
                </div>
                
                <div class="alert alert-info" id="statusMessage">Ожидание запуска...</div>
                
                <div class="mt-3" id="statsSection" style="display: none;">
                    <h6>Статистика обработки:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul id="statsList" class="list-group list-group-flush"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4" id="timingHistoryCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">История производительности</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="timingTable">
                        <thead>
                            <tr>
                                <th>Задача</th>
                                <th>Время</th>
                                <th>Элементов</th>
                                <th>Скорость</th>
                                <th>Дата</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут добавлены через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer mt-4 py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">Сканер документов &copy; {{ now.year }}</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            const progressCard = $('#progressCard');
            const timingHistoryCard = $('#timingHistoryCard');
            let scanInterval;
            let lastProcessedCount = 0;
            let lastUpdateTime = Date.now();
            
            $('#scanForm').on('submit', function(e) {
                e.preventDefault();
                
                // Скрываем карту истории времени при новом запуске
                timingHistoryCard.hide();
                
                $.ajax({
                    url: '/start-scan',
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.status === 'started') {
                            $('#startScanBtn').prop('disabled', true);
                            $('#stopScanBtn').prop('disabled', false);
                            progressCard.show();
                            $('#statusMessage').removeClass('alert-danger alert-warning').addClass('alert-info').text('Сканирование запущено...');
                            
                            // Запускаем опрос статуса
                            clearInterval(scanInterval);
                            scanInterval = setInterval(updateStatus, 1000);
                        }
                    },
                    error: function(xhr) {
                        alert('Ошибка: ' + xhr.responseText);
                    }
                });
            });
            
            $('#stopScanBtn').on('click', function() {
                $.ajax({
                    url: '/stop-scan',
                    method: 'POST',
                    success: function(response) {
                        if (response.status === 'stopped') {
                            $('#statusMessage').removeClass('alert-info alert-warning').addClass('alert-warning').text('Сканирование остановлено. Сохранение прогресса...');
                            // Продолжаем опрашивать статус для отображения сохранения чекпоинта
                        }
                    }
                });
            });
            
            function updateStatus() {
                $.get('/status', function(data) {
                    // Обновляем прогресс
                    $('#progressBar').css('width', data.progress + '%').text(data.progress + '%');
                    $('#progressText').text(data.progress + '%');
                    $('#currentTask').text(data.current_task || '-');
                    $('#processedCount').text(data.processed_items + ' из ' + data.total_items);
                    $('#elapsedTime').text(data.elapsed_time_formatted || '0с');
                    
                    // Рассчитываем скорость обработки
                    const currentTime = Date.now();
                    const timeDiff = (currentTime - lastUpdateTime) / 1000; // в секундах
                    const countDiff = data.processed_items - lastProcessedCount;
                    
                    if (timeDiff > 1 && countDiff > 0) {
                        const speed = countDiff / timeDiff;
                        $('#processingSpeed').text(speed.toFixed(1) + ' файлов/сек');
                        lastProcessedCount = data.processed_items;
                        lastUpdateTime = currentTime;
                    }
                    
                    // Обновляем оставшееся время
                    if (data.remaining_time > 0) {
                        $('#timeEstimate').text('Оставшееся время: ' + data.remaining_time_formatted);
                    }
                    
                    // Обновляем сообщение статуса
                    if (data.message) {
                        let alertClass = 'alert-info';
                        if (data.status === 'completed') alertClass = 'alert-success';
                        if (data.status === 'stopped' || data.status === 'error') alertClass = 'alert-warning';
                        
                        $('#statusMessage')
                            .removeClass('alert-info alert-success alert-warning alert-danger')
                            .addClass(alertClass)
                            .html(data.message.replace(/\n/g, '<br>'));
                    }
                    
                    // Обновляем статистику если есть
                    if (data.stats && Object.keys(data.stats).length > 0) {
                        $('#statsSection').show();
                        let statsHtml = '';
                        
                        // Общая статистика
                        statsHtml += `<li class="list-group-item"><strong>Обработано:</strong> ${data.stats.processed || 0}</li>`;
                        statsHtml += `<li class="list-group-item"><strong>Пропущено (маленькие файлы):</strong> ${data.stats.skipped_small || 0}</li>`;
                        statsHtml += `<li class="list-group-item"><strong>Пропущено (пустые файлы):</strong> ${data.stats.skipped_empty || 0}</li>`;
                        statsHtml += `<li class="list-group-item"><strong>Пропущено (дубликаты):</strong> ${data.stats.skipped_duplicate || 0}</li>`;
                        statsHtml += `<li class="list-group-item"><strong>Пропущено (ошибки):</strong> ${data.stats.skipped_error || 0}</li>`;
                        
                        // Статистика по типам файлов
                        if (data.stats.file_types && Object.keys(data.stats.file_types).length > 0) {
                            statsHtml += `<li class="list-group-item mt-2"><strong>Типы файлов:</strong></li>`;
                            for (const [ext, count] of Object.entries(data.stats.file_types)) {
                                statsHtml += `<li class="list-group-item ps-4">${ext}: ${count}</li>`;
                            }
                        }
                        
                        $('#statsList').html(statsHtml);
                    }
                    
                    // Проверяем статус для остановки опроса
                    if (data.status === 'completed' || data.status === 'error') {
                        clearInterval(scanInterval);
                        $('#startScanBtn').prop('disabled', false);
                        $('#stopScanBtn').prop('disabled', true);
                        
                        // Загружаем историю производительности после завершения
                        setTimeout(loadTimingHistory, 1000);
                    }
                    
                    // Проверяем, нужно ли приостановить работу из-за лимита времени
                    if (data.should_pause && data.status === 'running') {
                        $('#statusMessage')
                            .removeClass('alert-info alert-success alert-warning alert-danger')
                            .addClass('alert-warning')
                            .html('Система автоматически приостановит работу через 30 секунд из-за достижения суточного лимита времени. Прогресс будет сохранен.');
                    }
                });
            }
            
            function loadTimingHistory() {
                $.get('/timing-history', function(data) {
                    if (data && data.length > 0) {
                        timingHistoryCard.show();
                        let tableBody = $('#timingTable tbody');
                        tableBody.empty();
                        
                        data.forEach(item => {
                            const date = new Date(item.timestamp);
                            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                            const speed = item.items_per_second ? item.items_per_second.toFixed(1) : '0.0';
                            
                            tableBody.append(`
                                <tr>
                                    <td>${item.task}</td>
                                    <td>${formatDuration(item.duration)}</td>
                                    <td>${item.items_processed}</td>
                                    <td>${speed} эл/сек</td>
                                    <td>${formattedDate}</td>
                                </tr>
                            `);
                        });
                    }
                });
            }
            
            function formatDuration(seconds) {
                if (seconds < 0) seconds = 0;
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                
                if (hours > 0) {
                    return `${hours}ч ${minutes}м ${secs}с`;
                } else if (minutes > 0) {
                    return `${minutes}м ${secs}с`;
                } else {
                    return `${secs}с`;
                }
            }
        });
    </script>
</body>
</html>